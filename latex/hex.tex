% Options for packages loaded elsewhere
\PassOptionsToPackage{unicode}{hyperref}
\PassOptionsToPackage{hyphens}{url}
%
\documentclass{article}

\usepackage{authblk}

\usepackage{algorithm}
\usepackage{algpseudocode}

\usepackage{natbib}
\usepackage{amsmath,amssymb}
\usepackage{lmodern}
\usepackage{xcolor}
\usepackage[margin=1in]{geometry}
\usepackage{graphicx}

\newcommand{\reffig}[1]{Fig.~\ref{fig:#1}}

\title{Hexagonal Scan Interlacing}
\author{Jacob Hinkle\thanks{hinklejd@ornl.gov} 
}
\author{Debangshu Mukherjee\thanks{mukherjeed@ornl.gov}
}
\affil{
	%Computational Science and Engineering Division \\
	Oak Ridge National Laboratory
}
%\texttt{\{hinklejd,mukherjeed\}@ornl.gov}}

\begin{document}
\maketitle
{
\renewcommand{\thefootnote}{}
\footnote{We acknowledge that this manuscript has been authored by UT-Battelle, LLC under Contract No. DE-AC05-00OR22725 with the U.S. Department of Energy. The United States Government retains and the publisher, by accepting the article for publication, acknowledges that the United States Government retains a non-exclusive, paid-up, irrevocable, world-wide license to publish or reproduce the published form of this manuscript, or allow others to do so, for United States Government purposes. DOE will provide public access to these results of federally sponsored research in accordance with the DOE Public Access Plan (http://energy.gov/downloads/doe-public-access-plan). This research is sponsored by the Artificial Intelligence Initiative and the Interconnected Science Ecosystem (INTERSECT) Initiative as part of the Laboratory Directed Research and Development Program of Oak Ridge National Laboratory.}
\setcounter{footnote}{0}
}
\begin{abstract}
	Progressive acquisition of slowly-scanned images is desirable for drift-correction and realtime visualization.
	%
	Interlacing methods are common approaches to storage and transmission of data on rectilinear grids, and here we propose using them for acquisition in scanning-mode image modalities.
	%
	Especially in these cases, it is important to make optimal use of sample points in order to speed up the scan and reduce damage to the subject.
	%
	It has long been known that optimal sampling of band-limited signals is achieved using hexagonal scanning grids.
	%
	In this note, we demonstrate two new methods for interlacing hexagonal grids, which enable full field-of-view imaging with optimal sampling and resolution doubling.
\end{abstract}

\section{Introduction}
\label{sec:intro}

Typically, digital images are acquired using a charge-coupled device (CCD) which provides an image supported on a rectilinear grid.
%
However, in some modalities a subject is instead probed in a predefined (and often programmable) pattern to obtain a grid of point measurements.
%
This is the case in scanning probe microscopy (SPM), scanning transmission electron microscopy (STEM), confocal laser scanning microscopy, and others.
%
%In these scanning modalities, sample efficiency and other practical factors are often of the utmost importance.
Particularly when imaging sensitive subjects using invasive modalities such as STEM, sampling efficiency is critical to obtaining useful images before beam-induced damage ruins the sample.
%
To date, the predominant method of scanning in most modalities uses a square pixel grid scan pattern.
%
It is known that hexagonal grid patterns offer optimal sampling for circularly band-limited signals in the sense of minimizing aliasing for a given number of sample points~\citep{petersen1962}.
%
The availability of efficient hexagonal image processing methods makes the use of hexagonal grids in image processing more practical than in the past~\citep{birdsong2016hexfft,middleton2006hexagonal}.
%
There has been some study of hexagonal scan patterns in scanning optical microscopy~\citep{heintzmann2007}.
%
In STEM, some attention has been given to alternative scan patterns including spiral patterns~\citep{sang2016dynamic}, but to our knowledge hexagonal scan patterns have not yet been used in a real-world experiment.


In this note, we explore methods for progressive acquisition or transmission of hexagonal grids which acquire multiple images of increasing resolution each with a full field of view; such methods are known as interlacing methods.
%
Previous approaches to interlacing were designed to reduce the time to formation of an approximate image as additional data is transmitted over a bandwidth-limited connection.
%
The methods we introduce here extend these works to hexagonal grids, and discuss their characteristics in the context of optimal sampling for scanning imaging modalities.
%
Our methods are simple, scale to any required depth or resolution, and can be
implemented with a series of simple rectilinear sampling grids.

\subsection{Related Work}
\label{sec:wavelets}

Wavelets have hierarchical property and apply to hexagonal grids~ \citep{jeevan2014compression}
, but doesn't work for point sampling methods
like in scanning electron microscopy modalities.

TODO: spiral scan patterns, other stuff??


\section{Rectilinear Interlacing}
\label{sec:rect}

The two most popular interlacing methods are scanline interlacing as used in GIF and TGA file formats, and Adam7 interlacing as part of the early portable network graphics (PNG) 2D image file format~\citep{rfc2083}.
%
GIF/TGA: scanline interlacing. Similar to video interlacing

%
Note that only one pass is done, but is easily extended to a 1D iterative upscaling we will call ``scanline interlacing''.


The Adam7 algorithm is shown in \reffig{adam7phases}

%\begin{verbatim}
%1 6 4 6 2 6 4 6
%7 7 7 7 7 7 7 7
%5 6 5 6 5 6 5 6
%7 7 7 7 7 7 7 7
%3 6 4 6 3 6 4 6
%7 7 7 7 7 7 7 7
%5 6 5 6 5 6 5 6
%7 7 7 7 7 7 7 7
%\end{verbatim}

\begin{figure}[ht]
\centering
\includegraphics[
	%trim=70 50 70 25,
	clip,width=.9\textwidth]{adam7_phases.pdf}
\caption{\label{fig:adam7phases}
The Adam7 interlacing method for rectilinear grids.
%
	Starting from an initial grid (Phase 1), each subsequent phase consists of doubling the columns (blue) then rows (green) of the grid.
	}
\end{figure}


After every other pass of Adam7, the image resolution is doubled (the number of pixels is quadrupled).
%
We refer to two of these consecutive passes as a ``phase'', so that Adam7 consists of a base phase (initial image) and three upscaling phases.
%
Although Adam7 contains 7 subgrids and 3 upscaling phases, it is trivially extended to any number of phases.


\section{Hexagonal Interlacing Algorithms}
\label{sec:hexinter}

Here we explain two methods for interlacing hexagonal grids.
%
Each method is implemented using rectilinear grids.
%
The first method (double grid interlacing) requires only shifting the grids and doubling the resolution between passes.
%
The second method requires shifting, doubling, and rotating grids.


\subsection{Basic Hex Interlacing}
\label{double-grid-interlacing}

A hexagonal grid can be constructed from two identical rectilinear grids
whose pixel spacings are a multiple of $[1, \sqrt{3}]^T$ and which are offset from one another by half that spacing (see Fig.~\ref{fig:basicphases}, Phase 1).

\begin{figure}[ht]
\centering
% trim=left bottom right top
\includegraphics[
	%trim=140 65 115 10,
	clip,width=.9\textwidth]{basic_phases.pdf}
\caption{
\label{fig:basicphases} Refining a hex grid through multiple interlacing passes.
%
In each pass, previously sampled points are shown in gray.
%
Each pass consists of multiple rectilinear scans with aspect ratio $\sqrt{3}$.
%
TODO TODO: Fix method so that we don't drift left. Instead, alternate the orange dots horizontally. Also, in phase 2 move green grid down by one row...
}
\end{figure}

To refine a coarse hex grid with spacing $s$, we duplicate the grid reflected horizontally and shifted vertically by $\frac{\sqrt{3}}{2} s$ using two rectilinear grids.
%
The result is a rectilinear grid whose pixel spacing is $[s/2, \sqrt{3}]^T$.
%
We then fill the gaps with a double-resolution rectilinear grid to produce the final double-resolution hex grid with spacing $[s/2, \sqrt{3}/2]^T$.
%
%These steps are shown in detail in Algorithm~\ref{alg:basic}
%
We refer to one of these upscaling operations as a "phase" consisting of 3 rectilinear grids.
%
Additional phases are implemented identically, replacing $s$ with $s/2$.

%\begin{algorithm}
%\caption{Basic hex interlacing algorithm.}\label{alg:basic}
%\begin{algorithmic}
	%\State $c \gets (0, 0)$
%\end{algorithmic}
%\end{algorithm}


Note the similarities between this basic hex interlacing method and Adam7~(\reffig{basicphases}).

TODO: more detail on similarities to Adam7

\subsection{Rotational Hex Interlacing}
\label{triple-grid-interlacing}

The basic method works by duplicating an existing hex grid and flipping it horizontally to produce a rectilinear grid, then filling in a higher-resolution rectilinear grid to complete the upsampled hex grid.
%
However, instead of flipping, the duplicated hex grid could alternatively be offset along one of the three axes of symmetry in the hexagonal grid.
%
Using the lateral direction is nearly equivalent to flipping, but duplicating either of the other directions results in a rectilinear grid which is rotated by $\pm 120$ degrees.
%
In this method, which we call the ``rotational hex interlacing method,'' we perform this duplication then fill in the missing rectilinear grid which is again rotated by $\mp 120$ degrees.
%
The result is a method which can start from a single point or small grid and produce a hexagonally-shaped hex grid, placing samples more in a more uniform angular distribution about the center.



\begin{figure}[ht]
\centering
% trim=left bottom right top
\includegraphics[%trim=130 100 100 65,
	clip,width=.95\textwidth]{rotating_phases.pdf}
\caption{
\label{fig:rotatingphases} Refining a hex grid through multiple interlacing passes.
%
In each pass, previously sampled points are shown in gray.
%
Each pass consists of multiple rectilinear scans with aspect ratio $\sqrt{3}$.
}
\end{figure}

%\begin{algorithm}
%\caption{Rotational hex interlacing algorithm.}\label{alg:rotating}
%\begin{algorithmic}
	%\State $c \gets (0, 0)$
%\end{algorithmic}
%\end{algorithm}

TODO: Note after Phase $n$, all points on the lattice within $2^{n-1}$ graph distance of the origin are included in the fully-sampled interior region.

TODO: Note similarity to basic algorithm and to Adam7. We are always just doubling the hex grid along one of the lines of symmetry which creates a Cartesion grid, then filling in a direction perpendicular. The whole rotation thing is just an illusion because of using $\sqrt{3}$ aspect ratio subgrids instead of a $\frac{1}{\sqrt{3}}$ aspect subgrid rotated 90 degrees!

\subsection{Sampling Density}
\label{sec:density}

Note that unlike in other methods, using this method there are missing pixels on the periphery of the upscaled scan pattern.
%
That is, an interior hexagon is covered fully after each phase, but the exterior hexagon containing all of the points is not fully sampled.
%
However, note that each of the three full-diamater lines is fully sampled in 1D after each pass.


In this section, we characterize the density of sampling in various regions using the rotating hex interlacing method described above.
%
In order to derive expressions for sampling density, recall that each subgrid is a rotated rectilinear grid.
%
A single phase consists of two low-resolution subgrids followed by a subgrid with double the resolution, rotated 120 degrees clockwise.
%
In the central region, this results in a quadrupling of the sampling density after each phase.
%
This central region occupies one third of the overall area.
%
In the periphery, due to incomplete overlap, we must instead approximate the density.

\subsection{Trimmed Rotational Hex Interlacing}
\label{sec:trimmed}

The rotational hex interlacing method shown above results in a sampling density that peaks in an interior hexagon but includes a number of points outside this fully sampled region, as shown in \reffig{hexdensity}.
%
In some cases, only the fully sampled interior region is of interest, in which case any samples outside that region are wasteful.
%
In such situations, we simply trim the rectangular grids from 8x8 to 8x6 in Phase 3 in order to make them more square, while still completely covering the fully sampled interior.
%
Further phases require no modification as they merely double the grid.
%
The result is a method we call the trimmed rotational hex interlacing method and is shown in \reffig{trimmedrotatingphases}.
%
Using trimming, the interior sample density which constitutes only one third the overall area and half the total sample density

\begin{figure}[ht]
\centering
% trim=left bottom right top
\includegraphics[%trim=130 100 100 65,
	clip,width=.95\textwidth]{rotating_phases_trimmed.pdf}
\caption{
\label{fig:trimmedrotatingphases} 
The trimmed variant of the rotational hex interlacing method.
%
The first two phases are identical to the original rotational method, but the grids are only 75\% of the original height in subsequent phases.
%
The interior hexagon is still fully sampled while sparing 50\% of samples in the periphery.
}
\end{figure}


%
With trimming, the sampling density in the interior is unchanged but undersampled regions in the periphery are sampled even less.
%
This results in a concentration of points in the hexagonal-shaped interior region.


TODO: Finish out this section showing that interior after trimming is same \# points as best-case inscribed hex for a rectangular FOV and basic interlacing.
%
By comparison, the basic interlacing method, while simple to implement, results in a less uniform angular distribution of points than the trimmed rotational method~(see \reffig{angdens}).

\begin{figure}[ht]
\centering
% trim=left bottom right top
\includegraphics[%trim=130 100 100 65,
	clip,width=.49\textwidth]{converged_hex_density.pdf}
\includegraphics[%trim=130 100 100 65,
	clip,width=.49\textwidth]{converged_hex_density_trimmed.pdf}
\caption{
\label{fig:hexdensity}
	Asymptotic sampling density (normalized to the interior fully sampled region) using rotational hex interlacing (left) and its trimmed variant (right).
%
Each phase results in a rotation of this pattern by 60 degrees clockwise.
%
This converges to four decimal places after eight phases, and to seven decimal places after 13 phases.
%
%Note that the interior hexagon occupies one third the total area, the equilateral triangular regions have an average density of 2/3, and the obtuse isosceles triangular regions have an average density of 1/3, implying the interior region contains half the overall number of sample points.
TODO: Include square pattern sized to cover interior region.
%
TODO: Renormalize plots to sum to one (area weighted), showing increased density in interior due to trimming.
%
}
\end{figure}


\begin{figure}
\centering
% trim=left bottom right top
\includegraphics[%trim=130 100 100 65,
	clip,width=.7\textwidth]{angular_density.pdf}
\caption{
\label{fig:angdens} 
	Asymptotic angular distribution of samples using each of the proposed methods.
	%
	%Each method was normalized to have equal area (same total number of sample points).
}
\end{figure}

\subsection{Recursive Rectilinear Interlacing}
\label{sec:recursive}

One of the key motivations for interlaced scanning is to enable full-FOV tracking during sample acquisition.
%
However, in the methods listed above the last rectilinear subscan contains approximately half of the overall number of points.
%
Assuming each point takes an equal amount of time to acquire\footnote{This may not be true in general. For example when using different resolution grids in STEM, the dwell time and flyback may need some adjustment.}, this means that only one full-FOV subscan is acquired after half way through the overall scan time.
%
In order to enable further adaptivity, we propose to interlace the final rectilinear subscan as well by applying Adam7 interlacing to generate the final subscan.
%
This results in a new final subscan containing $\frac{1}{4}$ the total number of points, which itself could be interlaced, and so on recursively.
%
We refer to this approach of using $m$ recursive Adam7 passes in the final subscan with the suffix -$m$Adam7, e.g. TRHI6-2Adam7.
%
The effect of this further interlacing is shown in \reffig{subscanlengths}, showing finer granularity in the second half of the scan using recursive interlacing.


\begin{figure}
\centering
% trim=left bottom right top
\includegraphics[%trim=130 100 100 65,
	clip,width=.95\textwidth]{subscan_splits.pdf}
\caption{
\label{fig:subscansplits} 
Subscan lengths as portion of overall scan time for various approaches.
%
Within each row, each colored bar represents a single rectilinear subscan and its width is proportional to the number of sample points in that subscan.
%
TODO: Color each segment the same color as in the phases diagram
}
\end{figure}


\subsection{Impact on Montaging}
\label{sec:montaging}

- Very simple with basic method, but no overlap. In practice you need overlap in order to register. You could achieve this with basic, but would require further splitting grids in order to interleave, like a comb (figure?).

- Rotating grid method enables overlap without doubling the dose in those regions! That does require image interpolation using an irregular set of points; it remains to be seen what impact that would have on image registration in practice.

\section{Conclusion}
\label{sec:conclusion}

Interlaced scan patterns provide a potential for whole-FOV information early in the scan pattern.
%
This could be used in a microscopy setting to correct for sample drift during the scan, or to salvage an image that is degraded due to late-stage beam-induced damage in dose-sensitive samples.
%
Particularly for these dose-sensitive samples, optimal sampling is desired which makes the use of hexagonal grids attractive.
%
The methods we have described in this note provide practical methods for achieving interlaced hexagonal scan patterns.
%
The basic method is readily implemented and easy to handle, as it provides a square (two-grid) hexagonal pattern which is easy to process.
%
The rotating pattern is ideally suited for use in montaging schemes, due to the natural sharing of samples in the overlap regions, which avoids oversampling and introducing unnecessary dose there.


TODO: note that rotational pattern rotates the "fast and slow axes" among six directions, and that this is possible for the basic and rectilinear scans rotating among the four cardinal directions. In the presence of drift this may be helpful for reducing or detecting distortion.


TODO: note that these methods are designed for use with controllers that accept rectilinear grids only.

TODO: Note that we envision uses for interleaving including drift detection/correction.

\bibliographystyle{unsrtnat}
\bibliography{hex}

\end{document}
